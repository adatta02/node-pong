<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>

    <!-- Bootstrap -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="jquery-2.1.0.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="underscore-min.js"></script>
    <script src="cp.js"></script>
    
    <style>
    body {
        margin: 0px;
    }
    
    canvas { /* float below */
        position: absolute;
        top: 0;
        left: 0;
        z-index: -1;
    }
    </style>
    
  </head>
  
<body>
    <canvas></canvas>    
<script>

var ctx;
var canvas = $("canvas")[0];

var GRABABLE_MASK_BIT = 1<<31;
var NOT_GRABABLE_MASK = ~GRABABLE_MASK_BIT;
 
var canvasBackend = {
		
	scale: 0,
    
	run: function(){								
		this.drawScene();
		this.space.step(1/60);
		
        var raf = window.requestAnimationFrame
        || window.webkitRequestAnimationFrame
        || window.mozRequestAnimationFrame
        || window.oRequestAnimationFrame
        || window.msRequestAnimationFrame
        || function(callback) {
            return window.setTimeout(callback, 1000 / 60);
        };      
        
        var draw = _.bind(this.run, this);
        raf(draw);
	},
	
	drawScene: function(){
		var self = this;
		this.space.eachShape(function(shape) {	        
	        shape.draw(self.ctx);	        
	    });		
	},
	
	addDrawables: function(){
		
		this.ctx = $("canvas")[0].getContext('2d');		
		$("canvas").attr("width", window.innerWidth);
		$("canvas").attr("height", window.innerHeight);
		
        var width = canvas.width;
        var height = canvas.height;         
        window.scale = 0;          
        
        if (width/height > 640/480) {
            window.scale = height / 480;
        } else {
            window.scale = width / 640;
        }		
		
		cp.Shape.prototype.point2canvas = function(point){	        
			return cp.v( point.x * window.scale, (480 - point.y) * window.scale );
		};
		
		cp.Shape.prototype.drawLine = function(ctx, a, b){					
	        a = this.point2canvas(a); b = this.point2canvas(b);
	        ctx.beginPath();
	        ctx.moveTo(a.x + .5, a.y);
	        ctx.lineTo(b.x + .5, b.y);
	        ctx.stroke();
		};
		
		cp.Shape.prototype.drawCircle = function(ctx, c, radius){
		    var c = this.point2canvas(c);
		    ctx.beginPath();
		    ctx.arc(c.x, c.y, window.scale * radius, 0, 2 * Math.PI, false);
		    ctx.fill();
		    ctx.stroke();			
		}
		
		cp.SegmentShape.prototype.draw = function(ctx) {						
		    ctx.strokeStyle = "green";		    		    
		    ctx.fillStyle = "green";
		    ctx.lineCap = 'round';
		    ctx.lineWidth = this.lineWidth ? this.lineWidth : Math.max(1, this.r * window.scale * 2);
		    this.drawLine(ctx, this.ta, this.tb);
		};

		cp.CircleShape.prototype.draw = function(ctx) {	
			ctx.lineWidth = 1;
            ctx.strokeStyle = "black";                      
            ctx.fillStyle = "red";			
		    this.drawCircle(ctx, this.tc, this.r);
		    
		    ctx.strokeStyle = "white";                      
            ctx.fillStyle = "white";
		    this.drawLine(ctx, this.tc, cp.v.mult(this.body.rot, this.r).add(this.tc));
		};
		
	},
};

// The physics space size is 640x480, with the origin in the bottom left.
// Its really an arbitrary number except for the ratio - everything is done
// in floating point maths anyway.

var cpPong = function(){	
	
	this.addDrawables();
	
	var ball = null, paddleOne = null, paddleTwo = null;
	
	this.v = cp.v;
	this.space = new cp.Space();
		
	this.space.iterations = 60;
	this.space.gravity = this.v(0, -500);
	this.space.sleepTimeThreshold = 0.5;
	this.space.collisionSlop = 0.5;	
    
	this.addFloor();
	this.addWalls();
	
    var width = 50;
    var height = 60;
    var mass = 3;    
    var radius = 20;
        
    var body = this.space.addBody( new cp.Body(mass, cp.momentForCircle(mass, 0, radius, this.v(0, 0))) );
    body.setPos( this.v(200, 10) );
    
    this.ball = this.space.addShape(new cp.CircleShape(body, radius, this.v(0, 100)));
    this.ball.setElasticity(0.8);
    this.ball.setFriction(1);
    
    this.paddleOne = this.space.addShape( new cp.SegmentShape(this.space.staticBody, this.v(300, 75), this.v(375, 75), 10) );
    this.paddleOne.setElasticity(1.3);
    this.paddleOne.setFriction(1);
    this.paddleOne.setLayers(NOT_GRABABLE_MASK);  
    this.paddleOne.lineWidth = 10;
    
    this.paddleTwo = this.space.addShape( new cp.SegmentShape(this.space.staticBody, this.v(300, 420), this.v(375, 420), 10) );
    this.paddleTwo.setElasticity(1.3);
    this.paddleTwo.setFriction(1);
    this.paddleTwo.setLayers(NOT_GRABABLE_MASK);
    this.paddleTwo.lineWidth = 10;
    
    this.run();
};

_.extend( cpPong.prototype, canvasBackend );

cpPong.prototype.addFloor = function() {          
    var floor = this.space.addShape( new cp.SegmentShape(this.space.staticBody, this.v(0, 0), this.v(640, 0), 0) );
    floor.setElasticity(1);
    floor.setFriction(1);
    floor.setLayers(NOT_GRABABLE_MASK);
    
    var ceiling = this.space.addShape( new cp.SegmentShape(this.space.staticBody, this.v(0, 480), this.v(640, 480), 0) );
    ceiling.setElasticity(1);
    ceiling.setFriction(1);
    ceiling.setLayers(NOT_GRABABLE_MASK);   
};

cpPong.prototype.addWalls = function() {
    var space = this.space;
    var wall1 = space.addShape(new cp.SegmentShape(space.staticBody, this.v(0, 0), this.v(0, 480), 0));
    wall1.setElasticity(1);
    wall1.setFriction(1);
    wall1.setLayers(NOT_GRABABLE_MASK);

    var wall2 = space.addShape(new cp.SegmentShape(space.staticBody, this.v(640, 0), this.v(640, 480), 0));
    wall2.setElasticity(1);
    wall2.setFriction(1);
    wall2.setLayers(NOT_GRABABLE_MASK);
};

$(document).ready(function(){
	var cp = new cpPong();
});  
</script>
</body>
</html>